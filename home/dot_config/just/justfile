# Justfile for git workflows

# Find default branch (main or master)
default_branch := `git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main"`

# Show available commands
default:
    @just -g --list

# New branch from updated main/master
new branch-name:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "{{branch-name}}" ]; then
        echo "Usage: just -g new <branch-name>"
        exit 1
    fi
    git checkout {{default_branch}}
    git pull
    git checkout -b {{branch-name}}

# Merge current branch to main/master and push
merge:
    #!/usr/bin/env bash
    set -euo pipefail
    current=$(git branch --show-current)
    if [ "$current" = "{{default_branch}}" ]; then
        echo "Already on {{default_branch}}"
        exit 1
    fi
    git checkout {{default_branch}}
    git pull
    git merge --no-ff "$current"
    git push
    echo "Merged $current â†’ {{default_branch}}"

# Merge, push, and delete branch afterwards
merge-delete:
    #!/usr/bin/env bash
    set -euo pipefail
    current=$(git branch --show-current)
    just -g merge
    git branch -d "$current"
    git push origin --delete "$current" 2>/dev/null || true
    echo "Deleted $current"

# Push current branch and create PR (requires gh cli)
pr:
    git push -u origin HEAD
    gh pr create --fill

# Pull main and rebase current branch on top
sync:
    #!/usr/bin/env bash
    set -euo pipefail
    current=$(git branch --show-current)
    git fetch origin
    git rebase origin/{{default_branch}}
    echo "Rebased $current on {{default_branch}}"

# Delete all local branches merged to main
cleanup:
    #!/usr/bin/env bash
    set -euo pipefail
    git checkout {{default_branch}}
    git pull
    branches=$(git branch --merged | grep -v "^\*" | grep -v "{{default_branch}}" || true)
    if [ -z "$branches" ]; then
        echo "No merged branches to delete"
    else
        echo "$branches" | xargs git branch -d
        echo "Deleted merged branches"
    fi

# Quick WIP commit
wip:
    git add -A
    git commit -m "WIP"

# WIP commit with message
wip-msg msg:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -z "{{msg}}" ]; then
        echo "Usage: just -g wip-msg <message>"
        exit 1
    fi
    git add -A
    git commit -m "WIP: {{msg}}"

# Undo last WIP commit (keep changes)
unwip:
    git reset HEAD~1

# Python workflows

# Create Python virtual environment
new-venv:
    python3 -m venv venv
    @echo "Created venv. Activate with: source venv/bin/activate"
    source venv/bin/activate

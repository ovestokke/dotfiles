{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -uo pipefail

# terminal.yaml hash: {{ include ".chezmoidata/macos/terminal.yaml" | sha256sum }}

if ! command -v brew &> /dev/null; then
    echo "[SKIP] Homebrew not found, skipping package installation"
    exit 0
fi

echo "Installing Terminal Homebrew packages..."

failed=()
succeeded=()

{{ $data := include ".chezmoidata/macos/terminal.yaml" | fromYaml -}}
{{ $pkgs := $data.packages.darwin -}}
{{ range $pkgs.brews -}}
echo "Installing brew: {{ . }}"
if brew install {{ . | quote }} 2>/dev/null; then
    succeeded+=("brew:{{ . }}")
else
    failed+=("brew:{{ . }}")
fi
{{ end -}}

{{ range $pkgs.casks -}}
echo "Installing cask: {{ . }}"
if brew install --cask {{ . | quote }} 2>/dev/null; then
    succeeded+=("cask:{{ . }}")
else
    failed+=("cask:{{ . }}")
fi
{{ end -}}

echo ""
echo "Installation Summary:"
echo "Succeeded: ${#succeeded[@]}"
echo "Failed: ${#failed[@]}"

if [ ${#failed[@]} -gt 0 ]; then
    echo ""
    echo "Failed packages:"
    printf '  - %s\n' "${failed[@]}"
fi
{{- end }}


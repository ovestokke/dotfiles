{{- if eq .chezmoi.os "windows" }}
# Sync agent and skill files to chezmoi
# Agents live in ~/.claude/agents/
# Skills live in ~/.agents/skills/ and are symlinked into ~/.claude/skills/

$AgentsDir = Join-Path $env:USERPROFILE ".agents"
$ClaudeAgentsDir = Join-Path $env:USERPROFILE ".claude\agents"
$ClaudeSkillsDir = Join-Path $env:USERPROFILE ".claude\skills"

New-Item -ItemType Directory -Force -Path (Join-Path $AgentsDir "skills") | Out-Null
New-Item -ItemType Directory -Force -Path $ClaudeSkillsDir | Out-Null

Write-Host "Syncing agent files..."

# Add agent .md files from ~/.claude/agents/ to chezmoi
Get-ChildItem -Path $ClaudeAgentsDir -Filter "*.md" -ErrorAction SilentlyContinue | ForEach-Object {
    chezmoi add $_.FullName 2>$null
}

# Symlink skill dirs from ~/.agents/skills/ into ~/.claude/skills/
$skillsPath = Join-Path $AgentsDir "skills"
Get-ChildItem -Path $skillsPath -Directory -ErrorAction SilentlyContinue | ForEach-Object {
    $target = Join-Path $ClaudeSkillsDir $_.Name
    if (-not (Test-Path $target)) {
        New-Item -ItemType SymbolicLink -Path $target -Target $_.FullName | Out-Null
    }
}

# Add skill files to chezmoi
Get-ChildItem -Path $skillsPath -Recurse -File -ErrorAction SilentlyContinue | ForEach-Object {
    chezmoi add $_.FullName 2>$null
}

$lockFile = Join-Path $AgentsDir ".skill-lock.json"
if (Test-Path $lockFile) { chezmoi add $lockFile 2>$null }

Write-Host "Agent sync complete."
{{- end }}

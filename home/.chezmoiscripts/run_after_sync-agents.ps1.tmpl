{{- if eq .chezmoi.os "windows" }}
# Sync agent and skill files to chezmoi
# Agents live in ~/.claude/agents/
# Skills live in ~/.agents/skills/ and are symlinked into ~/.claude/skills/
# Only runs when monitored directories have changed.

$AgentsDir = Join-Path $env:USERPROFILE ".agents"
$ClaudeAgentsDir = Join-Path $env:USERPROFILE ".claude\agents"
$ClaudeSkillsDir = Join-Path $env:USERPROFILE ".claude\skills"
$CacheDir = Join-Path $env:LOCALAPPDATA "chezmoi"
$HashFile = Join-Path $CacheDir "agent-sync.hash"

New-Item -ItemType Directory -Force -Path (Join-Path $AgentsDir "skills") | Out-Null
New-Item -ItemType Directory -Force -Path $ClaudeSkillsDir | Out-Null
New-Item -ItemType Directory -Force -Path $CacheDir | Out-Null

# Compute a hash of all monitored files (names + last-write-times + sizes)
$entries = @()
Get-ChildItem -Path $ClaudeAgentsDir -Filter "*.md" -ErrorAction SilentlyContinue | ForEach-Object {
    $entries += "$($_.FullName) $($_.LastWriteTimeUtc.Ticks) $($_.Length)"
}
$skillsPath = Join-Path $AgentsDir "skills"
Get-ChildItem -Path $skillsPath -Recurse -File -ErrorAction SilentlyContinue | ForEach-Object {
    $entries += "$($_.FullName) $($_.LastWriteTimeUtc.Ticks) $($_.Length)"
}
$lockFile = Join-Path $AgentsDir ".skill-lock.json"
if (Test-Path $lockFile) {
    $lf = Get-Item $lockFile
    $entries += "$($lf.FullName) $($lf.LastWriteTimeUtc.Ticks) $($lf.Length)"
}

$blob = ($entries | Sort-Object) -join "`n"
$sha = [System.Security.Cryptography.SHA256]::Create()
$currentHash = [BitConverter]::ToString($sha.ComputeHash([Text.Encoding]::UTF8.GetBytes($blob))).Replace("-","").ToLower()

$previousHash = ""
if (Test-Path $HashFile) { $previousHash = Get-Content $HashFile -Raw }

if ($currentHash -eq $previousHash.Trim()) { exit 0 }

Write-Host "Syncing agent files..."

# Add agent .md files from ~/.claude/agents/ to chezmoi
Get-ChildItem -Path $ClaudeAgentsDir -Filter "*.md" -ErrorAction SilentlyContinue | ForEach-Object {
    chezmoi add $_.FullName 2>$null
}

# Symlink skill dirs from ~/.agents/skills/ into ~/.claude/skills/
Get-ChildItem -Path $skillsPath -Directory -ErrorAction SilentlyContinue | ForEach-Object {
    $target = Join-Path $ClaudeSkillsDir $_.Name
    if (-not (Test-Path $target)) {
        New-Item -ItemType SymbolicLink -Path $target -Target $_.FullName | Out-Null
    }
}

# Add skill files to chezmoi
Get-ChildItem -Path $skillsPath -Recurse -File -ErrorAction SilentlyContinue | ForEach-Object {
    chezmoi add $_.FullName 2>$null
}

if (Test-Path $lockFile) { chezmoi add $lockFile 2>$null }

$currentHash | Set-Content $HashFile -NoNewline
Write-Host "Agent sync complete."
{{- end }}

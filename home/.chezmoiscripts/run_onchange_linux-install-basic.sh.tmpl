{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -uo pipefail

# basic.yaml hash: {{ include ".chezmoidata/linux/basic.yaml" | sha256sum }}

echo "Installing Linux basic packages..."

failed=()
succeeded=()

# Detect WSL
IS_WSL=false
if grep -qi microsoft /proc/version 2>/dev/null || grep -qi wsl /proc/version 2>/dev/null; then
    IS_WSL=true
    echo "Detected WSL environment - using minimal package set"
fi

# Detect package manager and distribution
detect_distro() {
    if command -v pacman &> /dev/null; then
        echo "arch"
    elif command -v apt-get &> /dev/null; then
        echo "debian"
    else
        echo "unknown"
    fi
}

DISTRO=$(detect_distro)

{{ $data := include ".chezmoidata/linux/basic.yaml" | fromYaml -}}
{{ $pkgs := $data.packages.linux -}}

case "$DISTRO" in
    arch)
        echo "Detected Arch Linux (pacman)"

        # Update package database
        sudo pacman -Sy

        if [ "$IS_WSL" = true ]; then
            # WSL minimal packages
            {{ range $pkgs.pacman_wsl -}}
            echo "Installing: {{ . }}"
            if sudo pacman -S --noconfirm --needed {{ . }} 2>/dev/null; then
                succeeded+=("{{ . }}")
            else
                failed+=("{{ . }}")
            fi
            {{ end }}
        else
            # Full desktop packages
            {{ range $pkgs.pacman -}}
            echo "Installing: {{ . }}"
            if sudo pacman -S --noconfirm --needed {{ . }} 2>/dev/null; then
                succeeded+=("{{ . }}")
            else
                failed+=("{{ . }}")
            fi
            {{ end }}

            # Check for AUR helper (yay or paru)
            AUR_HELPER=""
            if command -v yay &> /dev/null; then
                AUR_HELPER="yay"
            elif command -v paru &> /dev/null; then
                AUR_HELPER="paru"
            fi

            if [ -n "$AUR_HELPER" ]; then
                echo "Using $AUR_HELPER for AUR packages..."
                {{ range $pkgs.aur -}}
                echo "Installing AUR: {{ . }}"
                if $AUR_HELPER -S --noconfirm --needed {{ . }} 2>/dev/null; then
                    succeeded+=("{{ . }} (AUR)")
                else
                    failed+=("{{ . }} (AUR)")
                fi
                {{ end }}
            else
                echo "[INFO] No AUR helper found (yay/paru)."
                echo "Install yay: git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si"
            fi
        fi
        ;;

    debian)
        echo "Detected Debian/Ubuntu (apt)"

        # Update package list
        sudo apt-get update

        if [ "$IS_WSL" = true ]; then
            # WSL minimal packages
            {{ range $pkgs.apt_wsl -}}
            echo "Installing: {{ . }}"
            if sudo apt-get install -y {{ . }} 2>/dev/null; then
                succeeded+=("{{ . }}")
            else
                failed+=("{{ . }}")
            fi
            {{ end }}
        else
            # Full desktop packages
            {{ range $pkgs.apt -}}
            echo "Installing: {{ . }}"
            if sudo apt-get install -y {{ . }} 2>/dev/null; then
                succeeded+=("{{ . }}")
            else
                failed+=("{{ . }}")
            fi
            {{ end }}
        fi
        ;;

    *)
        echo "[SKIP] Unknown distribution. Neither pacman nor apt-get found."
        echo "Supported distributions: Arch Linux, Debian, Ubuntu"
        exit 0
        ;;
esac

# Install Oh My Posh (cross-shell prompt)
if command -v oh-my-posh &> /dev/null; then
    echo "Oh My Posh already installed"
    succeeded+=("oh-my-posh (exists)")
else
    echo "Installing Oh My Posh..."
    if curl -s https://ohmyposh.dev/install.sh | bash -s 2>/dev/null; then
        succeeded+=("oh-my-posh")
    else
        failed+=("oh-my-posh")
    fi
fi

# Install Fisher (fish plugin manager) if fish is installed and Fisher is not
if command -v fish &> /dev/null; then
    if [ ! -f "$HOME/.config/fish/functions/fisher.fish" ]; then
        echo "Installing Fisher (fish plugin manager)..."
        if fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher" 2>/dev/null; then
            succeeded+=("fisher")
        else
            failed+=("fisher")
        fi
    else
        echo "Fisher already installed"
        succeeded+=("fisher (exists)")
    fi

    # Install useful fish plugins
    for plugin in "patrickf1/fzf.fish" "jethrokuan/z"; do
        plugin_name=$(echo "$plugin" | cut -d'/' -f2)
        if fish -c "fisher list" 2>/dev/null | grep -q "$plugin"; then
            echo "$plugin_name already installed"
            succeeded+=("$plugin_name (exists)")
        else
            echo "Installing $plugin_name..."
            if fish -c "fisher install $plugin" 2>/dev/null; then
                succeeded+=("$plugin_name")
            else
                failed+=("$plugin_name")
            fi
        fi
    done

    # Remind user about fish shell
    if [ "$SHELL" != "$(command -v fish)" ]; then
        echo ""
        echo "=========================================="
        echo "  Fish shell installed!"
        echo "=========================================="
        echo ""
        echo "  To try fish, just type:"
        echo "    fish"
        echo ""
        echo "  To set fish as your default shell:"
        echo "    chsh -s $(command -v fish)"
        echo ""
        echo "  Then log out and back in."
        echo "=========================================="
    fi
else
    echo "[SKIP] Fish not installed, skipping plugin installation"
fi

echo ""
echo "Installation Summary:"
echo "Succeeded: ${#succeeded[@]}"
echo "Failed: ${#failed[@]}"

if [ ${#failed[@]} -gt 0 ]; then
    echo ""
    echo "Failed packages:"
    printf '  - %s\n' "${failed[@]}"
fi
{{- end }}
